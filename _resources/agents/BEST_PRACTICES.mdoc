# Best Practices: 76 NextWebsite

## ü§ñ Multi-Agent Workflow
Follow the [[_RESOURCES/DATACORE/76 NextWebsite/_resources/agents/RALPH_WIGGUM|Ralph Wiggum Methodology]].
- **Tasks**: Store in `_resources/agents/tasks/[ID]_[TITLE].md`.
- **Implementation**: track in `_resources/agents/implementation/implementation_plan.md`.

## üé® Styling & Parity
- **Source of Truth**: Always edit `src/styles/styles.jsx`. Never edit `.generated.jsx` files directly.
- **Global Resets**: Use the `DebugManager` to inject global resets if browser-specific defaults interfere with
pixel-perfect parity.
- **Container Queries**: Use `cqw` and `cqh` units for scaling to ensure the website looks the same regardless of
whether it's in an Obsidian pane or a full browser tab.
- **Full-Height Pinning**: For full-page experiences (like games), use `position: absolute; inset: 0` on the root
container in inception mode to bypass Obsidian's host height constraints.
- **Premium Impact**: Favor heavy weights (800, 900) for headers and subtle letter-spacing adjustments for a pro look.
- **Fluid GRID_SIZE**: For canvas-based games, avoid fixed pixel grids. Use window-width ratios for `GRID_SIZE` (e.g.,
`Math.max(30, Math.min(80, Math.floor(w / 30)))`) to ensure immersion on both mobile and 4K displays.
- **Robust Viewport Scaling**: (NEW) Components rendered in Datacore sidebars or embedded contexts often find `vw`
(viewport width) unreliable.
- **Preference**: Use percentage-based widths (`width: 95%`) and `padding` instead of aggressive `vw` units (`width:
85vw`).
- **Clamping**: Always use `clamp()` for font sizes to ensure they degrade gracefully in narrow side panes without
clipping.

## üéÆ Responsive Game Development
Building immersive games that work from tiny sidebars to 4K monitors requires specialized patterns:

### 1. Ref-Based Dimension Sync
Never rely on React state or standard closures inside a `requestAnimationFrame` loop for coordinates.
- **Pattern**: Maintain a `dimsRef` that is updated on window resize.
- **Why**: The game loop runs at 60fps and needs the *raw* current boundaries. React state updates are too slow for
physics/AI pathfinding during a rapid resize.

### 2. Canvas "Mega-Scaling"
On massive displays (w > 1600px), increase the `GRID_SIZE` further. A 20px snake on a 4K monitor feels like a bug; a
60px snake feels like a "Power Move."

### 3. Safe Spawning Buffers
When placing game items (food, enemies), use a margin (e.g., `grid_width - 4`). This prevents items from hiding under
the browser's rounded corners or mobile safe areas.

### 4. Ultra-Safe UI Guardrails
On extremely narrow windows (
< 400px), standard titles often clip. Use: - **`maxWidth: 85vw`** + **`padding: 0 20px`** on the root container. -
  **Aggressive Clamps**: `fontSize: clamp(18px, 6vw, 120px)`. - **Gutters**: Mandatory horizontal padding ensures
  the "Character Clipping" failure is physically impossible. ## üß≠ Navigation & Layout Flow - **Sticky vs. Fixed**:
  Always prefer `position: sticky` for Navbars. - **Why**: Sticky elements naturally take up space in the document flow,
  pushing content down and preventing "Clipping" under the header. - **Fixed Pitfall**: `position: fixed` overlaps
  everything, requiring hardcoded `paddingTop` hacks which are brittle across screen sizes. - **Flexbox Chain**: Every
  parent in the hierarchy must use `display: flex`, `flexDirection: column`, and `minHeight: 0` to ensure `flex: 1`
  correctly propagates height to child components. - **Box Sizing**: Use `boxSizing: 'border-box' ` on the root
  container to ensure padding (like for navbars) doesn't calculate into total height and trigger unwanted scrollbars. ##
  üîÑ Build & Sync - **Shim Build**: Always run `npm run shim` after editing any component or style file. - **Intelligent
  Node.js Mocks**: For components that use Node built-ins (`fs`, `child_process`), `build-shim.js` provides functional
  web mocks. Avoid manually stubbing these in component code; let the shim handle it to preserve Obsidian functionality.
  - **Robust Dependency Lifting**: Use `dc.require` for all internal dependencies. The build shim now robustly "lifts"
  these (including `.js` utilities and un-declared assignments) to top-level ESM imports for the web. - **Generated
  Files**: Verify that `.generated.jsx` files contain the correct `export` statements and relative imports. - **Website
  View**: Test changes in the standard browser (`npm run dev`) only after verifying them in Datacore. ## üõ†Ô∏è Debugging -
  **DebugManager**: Use `debugManager.log()` for environment-aware logging. - **Console Versioning**: Check for the üíé
  (Datacore) or üåê (Website) emoji to confirm which environment is logged. - **Evaluation Logs**: Ensure components log
  their evaluation state to detect loading failures early. ## ‚ö†Ô∏è Common Pitfalls - **Missing Exports**: Ensure the shim
  build correctly transforms `return { Component }` into `export { Component }`. - **Absolute Paths**: Don't use them in
  components; use paths relative to `folderPath`. - **Hook Shadows**: Be careful when passing `useState`/`useEffect` as
  props; avoid naming collisions in sub-components. Standardize on using `dc.useState` etc. - **Overflow Hidden**: Never
  set `overflow: hidden` on root containers. Use `overflow: auto` or `min-height: min-content` to preserve scrollability
  across platforms. - **InvalidCharacterError**: This occurs when you try to render an **Object** (React Element) as a
  **Tag** (e.g., `<Element />`). Ensure your shim detects if the factory returned a function or an element and renders
it appropriately.
- **Next.js Root Conflict**: Next.js (Turbopack) can get confused if there is an `app/` directory at the root AND a
`src/app/` directory. Always favor `src/app/` for the web build and ensure root `app/` is removed to prevent "Ghost
File" behavior where edits to `src/app/page.jsx` are ignored.
- **Dependency Versioning**: (IMPORTANT) For stability in this environment, use **Next.js 15.1.6** and **React 19.0.0**.
Upgrading to 15.2+ may introduce module resolution issues with Keystatic's internal dependency graph. Stay pinned to
these versions in `package.json`.
- **NPM Cache Permissions**: If you encounter `EACCES` errors during `npm install` on macOS, use a local cache
directory: `npm install --cache ./.npm_cache`.

## ‚öôÔ∏è Background Tasks & Command Execution
When executing shell commands (like `npm run build`) from a Datacore component (e.g., `ControlPanel.jsx`):

### 1. Robust Shell Execution
Always use `child_process.spawn` with a **login shell** (`-l`) to ensure the user's full environment (NVM, Node paths,
etc.) is loaded.
- **Bad**: `exec('npm run build')` (Often fails with `sh: npm: command not found` or `Exit Code -2`).
- **Good**: `spawn('/bin/zsh', ['-l', '-c', 'npm run build'], { cwd: absolutePath })`.

### 2. Absolute Path Resolution
Commands like `spawn` require a system-absolute path for the `cwd` option. Datacore `folderPath` is often relative.
- **Resolution**: Use `dc.app.vault.adapter.getBasePath()` to resolve the vault root.
```javascript
const vaultPath = dc.app.vault.adapter.getBasePath();
const absolutePath = path.resolve(vaultPath, folderPath);
```

## üåâ Hybrid Compatibility (Next.js + Datacore)
For a component to work in both Datacore (Obsidian) and the Web build, it must follow these rules:

### 1. The "Inception" Prop
All components MUST check for the `isInception` prop.
- **`isInception: true`**: Component is embedded inside the WebsiteBuilder.
- **Action**: Disable "Full-Tab Mode," overlays, or high-z-index sidebars that would conflict with the host application.
```javascript
const [isFullTab, setIsFullTab] = useState(!props.isInception);
```

### 2. Async View Factories
Always use the `async function View` pattern. This allows the host (`DatacoreShim`) to await dependency loading via
`dc.require` before rendering the React component.
```javascript
async function View({ folderPath, isInception, ...props }) {
const { STYLES } = await dc.require(folderPath + '/src/styles/styles.jsx');
return function ViewComponent() { ... };
}
```

### 3. ESM Registry Registration
Components extracted from Markdown MUST be added to the build-time Registry.
- **Script**: `scripts/build-shim.js` transforms `return { View }` into `export { View }`.
- **Web Loader**: The web version uses dynamic imports from `registry.generated.jsx` to ensure JSX transformation by
Next.js/Turbopack.
- **Build-Shim Robustness**:
- **Top-Level Returns**: The shim must wrap top-level `return` statements (common in MD-extracted code) in an async
`View` function to be valid ESM.
- **Object Exports**: Files exporting object literals (e.g., `export { a: 1 }`) must be transformed into a `const
___exports = { ... }; export default ___exports;` pattern to avoid syntax errors in certain bundlers.
- **Non-Indented Matching**: The shim uses strict regex to only transform *top-level* returns, preventing accidental
wrapping of nested component logic.

### 4. Threading Props Through DatacoreShim

When a parent component (like `WebsiteBuilder`) needs to pass props (like `setCurrentPage`) to a deeply nested component
(like `RetroMorphGame/HeroSection`), the prop must be threaded through the entire chain:

```
WebsiteBuilder ‚Üí MarkdownRenderer ‚Üí DatacoreShim ‚Üí AsyncFactory ‚Üí InnerComponent ‚Üí ChildComponent
```

**Step-by-Step Guide:**

#### A. Parent passes prop to MarkdownRenderer
```javascript
// WebsiteBuilder.jsx
<MarkdownRenderer content="{component: RetroMorphGame}" setCurrentPage={setActiveTab} // ‚Üê Pass the prop ... />
```

#### B. MarkdownRenderer spreads via `{...props}` to DatacoreShim
The MarkdownRenderer already does this via line ~148: `
<Shim {...props} />`

#### C. DatacoreShim must extract and forward the prop
```javascript
// DatacoreShim.jsx
function DatacoreShim(props) {
const { name, componentProps = {}, folderPath, STYLES, setCurrentPage } = props;
// ‚Üë Extract it

// Pass to async factory:
const factoryResult = await Comp({
...componentProps,
setCurrentPage, // ‚Üê Include here
...
}, localDc);

// Pass in final render:
return
<Component setCurrentPage={setCurrentPage} ... />;
}
```

#### D. Async Factory must capture and forward to inner component
```javascript
// RetroMorphGame/index.jsx
async function View({ folderPath, setCurrentPage: factorySetCurrentPage, ...props }) {
// ‚Üë Capture from factory props with alias

return function RetroMorphGame(componentProps) {
// Use closure variable OR fallback to componentProps
return (
<HeroSection setCurrentPage={factorySetCurrentPage || componentProps?.setCurrentPage} />
);
}
}
```

#### E. Child component uses the prop
```javascript
// HeroSection.jsx
function HeroSection({ setCurrentPage, ... }) {
// Use for internal navigation
onClick={() => setCurrentPage && setCurrentPage('GAMES')}
}
```

> [!IMPORTANT]
> The async factory pattern creates a **closure**. Props passed to the factory (`factorySetCurrentPage`) are captured at
factory-execution time. Props to the returned component (`componentProps`) are passed at render time. Use both with a
fallback for maximum flexibility.

### 5. Hook Parity
Use the global `dc` object for all React hooks.
- **Datacore**: `dc` is the native Datacore API.
- **Web**: `page.jsx` injects real React hooks into `window.dc`.
- **Requirements**: Ensure `useState`, `useEffect`, `useRef`, `useCallback`, and `useMemo` are all available in the
shim.
- **Rule**: Avoid `import { useState } from 'react'` inside the raw code blocks if the component needs to be shimmed;
the build-shim will handle the conversion.

### 6. UI Shimming
Native Datacore elements (like `dc.Icon`) must have web fallbacks.
- **Implementation**: Add shim components to `src/web/shim.js` to prevent "Element type is invalid" errors.

## üñ•Ô∏è UI & UX Patterns
- **Complex Settings**: Use a **Toolbar + Drawer** pattern for complex configurations (like `ControlPanel.jsx`) to keep
the main view clean.
- **Tabbed Interfaces**: Break down dense forms into logical tabs (e.g., Deploy, GitHub, Cloudflare, DNS).
- **Feedback Loops**:
- Lift status state (building/success/fail) to the parent component to show global indicators (badges) in the header.
- Provide explicit "Busy" or "Live" badges.
- **Input Styling**: Ensure text inputs and selects have sufficient height (`38px+`) and padding (`12px`).
- **Vertical Centering**: Use `line-height: {height}` for `select` elements to ensure text is perfectly centered and not
clipped by WebKit defaults.
- **Z-Index Management**: Use high z-indices (`10000+`) for custom tooltips/popovers to ensure they aren't clipped by
container overflows.

## ‚òÅÔ∏è Integrations (Cloudflare & GitHub)
- **Keychain First**: All tokens (`GITHUB_TOKEN`, `CF_API_TOKEN`) must be stored in the native Keychain
(`dc.app.secretStorage`).
- **NO .env SECRETS**: Never write sensitive tokens to `.env` or `localStorage`. Cleartext storage is a security
violation.
- **Zone Fetching**: Explicitly set `per_page=50` when fetching Cloudflare zones.
- **Resilient Polling**: All integration polling (e.g., Cloudflare deployment status) MUST implement graceful fallback
for 404/Not Found errors.
- **Action**: Stop the polling interval immediately if the target resource (project, repo) is reported missing by the
API.
- **Feedback**: Provide a clear UI state or log message explaining why the polling stopped and how the user can fix it
(e.g., "Verify project name").
- **Token Permissions**:
- GitHub: `repo` / `public_repo` / `delete_repo`.
- Cloudflare: `Account:Read`, `Pages:Edit`, `Zone:Read`, `DNS:Edit`.

## üîê Native Keychain Management
Use the high-level v1.11.4+ API for all sensitive data:
```javascript
const storage = dc.app.secretStorage;
const token = await storage.getSecret('dc_github_token');
await storage.setSecret('dc_github_token', 'ghp_...');
```
- **Injection**: The `ControlPanel` automatically injects these since into the build environment. Agents do not need to
manage `.env` files for these variables.

## üìú Separation of Concerns (Content vs. Code)
- **State Drives UI, Content Drives State**: Use the **Orchestrator Pattern** (`INDEX.md`) to define your site's
structure (Navigation) and content (Pages).
- **No Hardcoded Text**: Avoid burying copy in JSX. If a user might want to change it, put it in Markdown.
- **Components as Tools**: Build generic wrappers (`WebsiteBuilder`, `HeroSection`) that accept content as props. Don't
build "The About Page Component"; build a "Content Section" that renders `about.md`.

## üó∫Ô∏è Navigation Management
To add or remove navigation tabs (burger menu items):

### 1. Primary Source: `INDEX.md`
Edit `src/data/content/INDEX.md` to add/remove items from the `navigation` array.

#### Simple Internal Links (Legacy)
```yaml
navigation:
- HOME
- GAMES
```

#### Extended Format (Recommended)
Supports internal pages, external links, and separators:
```yaml
navigation:
- label: BEGIN
value: HOME
- label: GAMES
value: GAMES
- label: ABOUT
value: ABOUT
- separator: true
- label: HOME
url: https://beto.group
external: true
- label: MARKETPLACE
url: https://marketplace.beto.group
external: true
- label: SUPPORT
url: https://beto.group/support
external: true
```

> [!CAUTION]
> **Do NOT use YAML comments (`#`) in INDEX.md!** The custom frontmatter parser doesn't fully support them and they may
render as menu items.

**Item Properties:**
| Property | Type | Description |
|----------|------|-------------|
| `label` | string | Display text in the menu |
| `value` | string | Internal route (for SPA navigation) |
| `url` | string | External URL (opens in new tab) |
| `external` | boolean | Marks as external (shows ‚Üó arrow) |
| `separator` | boolean | Renders a horizontal divider line |

### 2. Fallback in `Navbar.jsx`
The `Navbar.jsx` component has a fallback array used when no `navItems` prop is passed. **Keep both sources in sync** to
avoid discrepancies.

### 3. After Changes
Always run `npm run shim` to regenerate `.generated.jsx` files for the web build.

### 4. Component-Level Navigation
Some components (like `RetroMorphGame`) have their own internal navigation/leaderboards. These are **independent** of
the main site navigation and should not be affected when modifying the burger menu.

## 13. Cloudflare Pages Deployment

### 1. Static Export Configuration
To deploy to Cloudflare Pages (Standard/Static), you must configure Next.js for static export.
- **`next.config.js`**: Set `output: 'export'`.
- **Image Optimization**: Must use `images: { unoptimized: true }` as Cloudflare Pages doesn't support the default
Next.js Image Optimization API.

### 2. CI/CD & Log Filtering
Cloudflare's build limits are strict. Massive log spam (e.g., from `jsconfig-paths-plugin`) can cause timeouts or
truncated logs.
- **Line-by-Line Filtering**: Use a wrapper script like `debug-build.js` to filter known spam *line-by-line*.
- **Avoid Chunk Filtering**: Never filter whole chunks, as valuable error context might be lost.

### 3. Keystatic & Admin Panel
Keystatic requires dynamic API routes to function, which are incompatible with `output: 'export'`.
- **Workflow**: Run Keystatic locally (`npm run dev`) to edit content.
- **Production**: The `/admin` route and `/api/admin` endpoints should be static placeholders (or 404s) in the
production build.
- **GitHub Sync**: Push content changes to GitHub to trigger a new Cloudflare deployment.
## 14. Favicon Auto-Generation System

### How It Works
`scripts/generate-favicons.js` reads `public/logo.png` and automatically generates all browser-required favicon
variants using `sharp` (already available in the project). It runs automatically as part of `npm run shim`
(which runs on every `npm run dev` and `npm run build`).

Run manually: `npm run favicons`

**Generated Files** (all in `public/`):

| File | Size | Purpose |
|------|------|---------|
| `favicon.ico` | 32x32 PNG-in-ICO | Legacy browsers, search crawlers |
| `favicon-16x16.png` | 16x16 | Browser tab small |
| `favicon-32x32.png` | 32x32 | Browser tab retina |
| `icon.png` | 32x32 | Next.js metadata API |
| `apple-touch-icon.png` | 180x180 | iOS "Add to Home Screen" |
| `icon-192.png` | 192x192 | Android PWA |
| `icon-512.png` | 512x512 | Android PWA splash |

Also auto-updates `manifest.json` with correct icon entries.

### How to Change the Logo
1. Replace `public/logo.png` with your new logo.
2. Run `npm run dev` ‚Äî all sizes regenerate automatically.
3. Hard-reload the browser (`Cmd+Shift+R`) to clear the favicon cache.

### Important: Delete Stale Files
Browsers auto-discover any `favicon.png` found in `/public`, even if you've moved to `favicon.ico`. Delete
stale favicon variants not part of the generator's output set.

### layout.jsx Metadata Format
```javascript
icons: {
    icon: [
        { url: '/favicon-16x16.png', sizes: '16x16', type: 'image/png' },
        { url: '/favicon-32x32.png', sizes: '32x32', type: 'image/png' },
    ],
    shortcut: '/favicon.ico',
    apple: { url: '/apple-touch-icon.png', sizes: '180x180', type: 'image/png' },
    other: [
        { url: '/icon-192.png', sizes: '192x192', type: 'image/png' },
        { url: '/icon-512.png', sizes: '512x512', type: 'image/png' },
    ],
},
```

## 15. Scroll Elimination for Embedded Full-Screen Games

When a game component is embedded in a scrollable Next.js page, `overflow: hidden` on the game div is NOT
enough ‚Äî the page body itself can still scroll. Two-part fix required:

**1. `position: fixed` on the container** (takes game out of document flow entirely):
```javascript
container: {
    position: 'fixed', top: 0, left: 0,
    width: '100vw',
    height: '100dvh',   // dvh = dynamic viewport height, accounts for mobile browser chrome
    overflow: 'hidden',
    zIndex: 100,        // Sits above the website navbar
}
```

**2. Body scroll-lock via `<style>` tag** (prevents iOS touch/momentum scroll):
```jsx
<style>{`
    body, html { overflow: hidden !important; overscroll-behavior: none !important; }
`}</style>
```

**Key rules**:
- Use `100dvh` not `100vh` or `100svh` ‚Äî adapts when mobile browser chrome shows/hides.
- `minHeight` will NOT work ‚Äî always use `height` for scroll elimination.
- Without the body lock, iOS Safari momentum scroll can still scroll the page behind the fixed game.

## 16. PWA "Add to Home Screen" / Mobile Install Flow

### Overview
Components can self-manage the PWA install (Add to Home Screen) experience without threading props
through the entire WebsiteBuilder chain. The pattern below works in both Datacore and Web.

### Required Files
| File | Purpose |
|------|---------|
| `public/sw.js` | Service worker ‚Äî required for Android Chrome to offer install |
| `src/hooks/usePWAInstall.jsx` | Standalone hook for reuse |
| `public/manifest.json` | Must have `display: "standalone"` and icon entries |

### Self-Contained Component Pattern (HeroSection.jsx)
Use `_useState`/`_useEffect` (underscore-prefixed) to avoid shadowing the React imports
that the build-shim injects at the top of generated files:

```javascript
function HeroSection({ STYLES, buttonText, dc }) {
    const localDc = dc || (typeof window !== 'undefined' ? window.dc : null);
    // _useState/_useEffect avoids shadowing React imports injected by build-shim
    const _useState = (typeof useState !== 'undefined' ? useState : null) || localDc?.useState;
    const _useEffect = (typeof useEffect !== 'undefined' ? useEffect : null) || localDc?.useEffect;

    const [deferredPrompt, setDeferredPrompt] = _useState(null);
    const [canInstall, setCanInstall] = _useState(false);
    const [isIOS, setIsIOS] = _useState(false);
    const [isInstalled, setIsInstalled] = _useState(false);

    _useEffect(() => {
        if (typeof window === 'undefined') return;
        const ios = /iphone|ipad|ipod/i.test(navigator.userAgent);
        setIsIOS(ios);
        const standalone = window.matchMedia('(display-mode: standalone)').matches
            || window.navigator.standalone === true;
        setIsInstalled(standalone);
        if (standalone || ios) { if (ios) setCanInstall(true); return; }

        const onPrompt = (e) => { e.preventDefault(); setDeferredPrompt(e); setCanInstall(true); };
        window.addEventListener('beforeinstallprompt', onPrompt);
        window.addEventListener('appinstalled', () => { setIsInstalled(true); setCanInstall(false); });
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(() => {});
        return () => window.removeEventListener('beforeinstallprompt', onPrompt);
    }, []);

    const handleInstall = async () => {
        if (isIOS) { /* show modal with Share ‚Üí Add to Home Screen instructions */ return; }
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        setDeferredPrompt(null);
    };
}
```

### Platform Behavior
| Platform | Trigger | What Happens |
|---|---|---|
| Android Chrome | `beforeinstallprompt` event | Native Chrome install banner |
| iOS Safari | Always available (no event) | Show manual Share ‚Üí "Add to Home Screen" modal |
| Already installed | `display-mode: standalone` | Button disabled / shows "‚úì INSTALLED" |
| Desktop | No `beforeinstallprompt` | Show default button text |

### Button Label Pattern
```javascript
const installLabel = isInstalled ? '‚úì INSTALLED'
    : isIOS ? '‚äï ADD TO HOME SCREEN'
    : canInstall ? '‚äï INSTALL APP'
    : defaultButtonText;
```

### iOS Instructions Modal
iOS does NOT support `beforeinstallprompt`. Show a bottom-sheet modal with:
- Instruction to tap the Share button (‚éã) in Safari
- Then tap "Add to Home Screen"
- Positioned `position: fixed; bottom: 40px` with an animated arrow pointing down

### Important Notes
- Android `beforeinstallprompt` only fires over **HTTPS** (works on localhost for dev)
- The service worker (`sw.js`) must be at the root `/sw.js` ‚Äî not a subdirectory
- `manifest.json` must have `"display": "standalone"` for the OS to recognize it as installable
- iOS standalone detection: `window.navigator.standalone === true` (not matchMedia)
